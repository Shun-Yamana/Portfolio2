AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Lambda Commander for SSM Patch Manager (On-Demand Execution)

Parameters:
  PatchGroupName:
    Type: String
    Default: StudyEC2PatchGroup
    Description: Target PatchGroup tag value

Resources:
  #####################################
  # Lambda Function
  #####################################
  PatchCommanderLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: PatchCommander
      Runtime: python3.12
      Handler: index.lambda_handler
      Timeout: 300
      Role: !ImportValue PatchCommanderRoleArn
      Environment:
        Variables:
          PATCH_GROUP: !Ref PatchGroupName
      Code:
        ZipFile: |
          import boto3
          import os

          ec2 = boto3.client('ec2')
          ssm = boto3.client('ssm')

          def lambda_handler(event, context):
              patch_group = os.environ['PATCH_GROUP']

              # Discover target EC2 instances
              response = ec2.describe_instances(
                  Filters=[
                      {
                          'Name': 'tag:PatchGroup',
                          'Values': [patch_group]
                      },
                      {
                          'Name': 'instance-state-name',
                          'Values': ['running']
                      }
                  ]
              )

              instance_ids = []
              for reservation in response['Reservations']:
                  for instance in reservation['Instances']:
                      instance_ids.append(instance['InstanceId'])

              if not instance_ids:
                  return {
                      'status': 'NO_TARGET',
                      'message': 'No running instances found for PatchGroup'
                  }

              # Execute Patch Manager
              command = ssm.send_command(
                  InstanceIds=instance_ids,
                  DocumentName='AWS-RunPatchBaseline',
                  Parameters={
                      'Operation': ['Install'],
                      'RebootOption': ['RebootIfNeeded']
                  }
              )

              return {
                  'status': 'EXECUTED',
                  'command_id': command['Command']['CommandId'],
                  'target_instances': instance_ids
              }

  #####################################
  # CloudWatch Logs
  #####################################
  PatchCommanderLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/PatchCommander
      RetentionInDays: 14

Outputs:
  LambdaFunctionName:
    Description: Lambda function name
    Value: !Ref PatchCommanderLambda
    Export:
      Name: PatchCommanderLambdaName

  LambdaFunctionArn:
    Description: Lambda function ARN
    Value: !GetAtt PatchCommanderLambda.Arn
    Export:
      Name: PatchCommanderLambdaArn
